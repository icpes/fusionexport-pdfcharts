name: FusionExport PDF Generator & Azure Function Deployment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      # ğŸ§© Step 1: Checkout your repo
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ§  Step 2: Debug â€” list all files that will be deployed
      - name: List deployment files
        shell: pwsh
        run: |
          Write-Host "ğŸ“‚ Listing all files in the workspace..."
          Get-ChildItem -Recurse | Select-Object FullName

      # ğŸš€ Step 3: Run FusionExport to generate PDF (optional build/test step)
      - name: Run FusionExport batch via PowerShell
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Running FusionExport via PowerShell..."
          & cmd /c run.bat

      # ğŸ“¤ Step 4: Upload the generated PDF as an artifact
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: FusionExportPDF
          path: output/*.pdf

      # ğŸ” Step 5: Login to Azure using the publish profile secret
      - name: Azure Login
        uses: azure/login@v1
        with:
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}

      # ğŸ—œï¸ Step 6: Package your app (including the batch + exe + chrome)
      - name: Zip Function App
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Creating deployment zip for Azure Function..."
          Compress-Archive -Path * -DestinationPath functionapp.zip -Force
          Write-Host "âœ… Zip file created: functionapp.zip"

      # â˜ï¸ Step 7: Deploy to Azure Function
      - name: Deploy to Azure Function
        uses: azure/functions-action@v1
        with:
          app-name: "fusionexport-function"  # ğŸ”¹ replace this
          package: "functionapp.zip"

      # ğŸ§  Step 8: Confirm deployment contents (optional final verification)
      - name: Verify zip contents
        shell: pwsh
        run: |
          Write-Host "ğŸ§ Verifying contents of the zip..."
          Expand-Archive -Path functionapp.zip -DestinationPath temp_extract -Force
          Get-ChildItem -Recurse temp_extract | Select-Object FullName
